<!-- Title -->
<h1 align="center">YMaps Excel Export</h1>

<p align="center">
  Выгрузка организаций из Яндекс.Карт в Excel (.xlsx): API-режим (опционально) + OFFLINE_HTML + WEB enrich (requests / Selenium)
</p>

<p align="center">
  <a href="#возможности">Возможности</a> •
  <a href="#режимы-работы">Режимы работы</a> •
  <a href="#требования">Требования</a> •
  <a href="#установка">Установка</a> •
  <a href="#настройка">Настройка</a> •
  <a href="#настройка-selenium">Настройка Selenium</a> •
  <a href="#запуск">Запуск</a> •
  <a href="#формат-выходного-файла">Формат выходного файла</a> •
  <a href="#структура-проекта">Структура проекта</a> •
  <a href="#частые-проблемы">Частые проблемы</a> •
  <a href="#gitignore">.gitignore</a> •
  <a href="#лицензия-и-ответственность">Лицензия и ответственность</a>
</p>

---

## Возможности

- Выгрузка организаций в Excel (.xlsx) в удобной табличной форме: один запуск — один файл.
- Сбор данных из нескольких источников (в зависимости от режима):
  - OFFLINE_HTML: парсинг сохранённой HTML-страницы выдачи Яндекс.Карт (боковой список).
  - WEB enrich: дозаполнение контактов и полей из web‑карточки организации (по oid).
  - API-режим (опционально, если включён в вашей сборке): поиск организаций по тексту в заданной области через API Поиска по организациям.
- Selenium fallback:
  - если данные не извлекаются “быстро”;
  - если контент дорисовывается JavaScript-ом;
  - если требуется дождаться появления контактов в DOM.
- В Excel сохраняется:
  - лист «Организации» — результаты (контакты, адрес, координаты, категории и т.п.);
  - лист «Запрос» — параметры запуска, статистика, предупреждения/ошибки.
- Для каждой строки сохраняется raw_json (служебная трассировка), чтобы при необходимости позже извлекать дополнительные поля без повторного парсинга.

---

## Режимы работы

Режимы задаются в файле settings.py.

1) OFFLINE_HTML (основной практический режим)
- Скрипт читает один HTML-файл или папку с HTML-файлами.
- Извлекает организации из бокового списка.
- При необходимости запускает дозаполнение WEB enrich.

2) WEB enrich (дозаполнение карточки)
- По каждому oid открывает URL вида:
  https://yandex.ru/maps/org/oid/
- Пытается извлечь:
  - сайт;
  - телефоны;
  - email (если доступен);
  - рейтинг и количество отзывов (если они присутствуют в разметке).

3) API-режим (опционально)
Если в вашем коде присутствует API логика:
- Выполняется поиск по текстовому запросу в области bbox.
- Возможен requery по uri для уточнения карточки.
- WEB enrich может использоваться как fallback для полей, отсутствующих в API.

---

## Требования

- Windows 10/11 (поддерживается также Linux/macOS при корректной настройке окружения).
- Python 3.10+ (рекомендуется).
- Google Chrome (для Selenium).
- Интернет-доступ (для WEB enrich и API-режима).
- Ключ API Поиска по организациям (только если вы используете API‑режим).

---

## Установка

### 1) Клонирование репозитория

git clone https://github.com/sadovnikovv/ParserYandexMap.git
cd ParserYandexMap

### 2) Виртуальное окружение (рекомендуется)

Windows (PowerShell):
python -m venv .venv
..venv\Scripts\Activate.ps1

Linux/macOS:
python3 -m venv .venv
source .venv/bin/activate

### 3) Установка зависимостей

pip install -r requirements.txt

---

## Настройка

Все основные настройки централизованы в settings.py (это сделано специально, чтобы не “копировать весь main.py” при каждой правке).

### A) Подготовка входных данных OFFLINE_HTML

1) Создайте папку:
- html

2) Положите туда сохранённые файлы *.html.

Важно:
- OFFLINE_HTML парсит только то, что реально сохранено в файле.
- Если боковой список не пролистать до конца, в HTML не будет всех организаций.

Рекомендуемый порядок сохранения:
- Открыть выдачу Яндекс.Карт.
- Пролистать боковой список до конца (пока элементы перестанут догружаться).
- Сохранить страницу в HTML.
- Положить файл в папку html

### B) Результаты (рекомендуется)

Чтобы не засорять дерево репозитория:
- результаты сохраняйте в папку results
- папку results добавьте в .gitignore
- держите в гите только results/.gitkeep

### C) Настройки settings.py — что означает каждый параметр

Ниже — список ключевых параметров и допустимых вариантов.

Режимы:
- MODE
  - OFFLINE_HTML

- OFFLINE_HTML_INPUT
  - ./html               (папка с .html)
  - ./html/file.html     (один конкретный файл)

- OFFLINE_ENRICH_MODE
  - NONE                 (без дозаполнения)
  - WEB                  (дозаполнение по web‑карточкам)

Вывод:
- OUT_DIR
  - ./results            (рекомендуется)
- OUT_PREFIX
  - out                  (имя будет out_YYYY-MM-DD_HH-MM-SS.xlsx)

WEB enrich:
- WEB_FORCE_OVERWRITE
  - True  — разрешить перезаписывать существующие значения в строке
  - False — заполнять только пустые поля

- WEB_MAX_ITEMS
  - Ограничение количества организаций для дозаполнения за один запуск.
  - Полезно при тестировании, чтобы не обрабатывать сразу сотни объектов.

- SLEEP_SEC
  - Пауза между запросами/обработкой организаций (снижает риск блокировок и 429).

Chrome / Selenium:
- CHROME_EXE
  - Путь к chrome.exe (Windows), например:
    C:\Program Files\Google\Chrome\Application\chrome.exe

- DEBUG_HOST / DEBUG_PORT
  - Адрес и порт remote debugging (обычно 127.0.0.1:9222).

- CHROME_PROFILE_DIR
  - Папка профиля Chrome для парсера (отдельно от вашего основного профиля).

- SELENIUM_HEADLESS
  - False — рекомендуется для отладки и ручного решения проверок
  - True  — headless, если уверены в стабильности

- SELENIUM_WAIT_CONTACTS_SEC
  - Сколько ждать появления контактов/сайта на странице перед чтением page_source.

---

## Настройка Selenium

Скрипт использует Selenium как “план Б”, когда страница отдаёт мало данных, либо контакты дорисовываются динамически.

### 1) Проверка Chrome

Убедитесь, что Chrome установлен и путь в settings.py (CHROME_EXE) корректный.

### 2) Как работает подключение

Сценарий:
- Скрипт запускает Chrome с remote debugging (host/port) и отдельным профилем.
- Selenium подключается к этому Chrome и получает страницу организации.
- Скрипт ждёт появления блоков контактов, затем читает HTML (page_source).

Это удобно, потому что:
- можно видеть реальную страницу;
- можно вручную решить проверку, если она появилась.

### 3) Если появилась проверка (captcha/challenge)

Действия:
1) Посмотрите на окно Chrome, которое открылось.
2) Решите проверку вручную.
3) Вернитесь в консоль и нажмите Enter (скрипт продолжит выполнение).

Важно:
- скрипт не обещает автоматический обход капчи;
- ответственность за корректность использования лежит на пользователе.

---

## Запуск

Из папки проекта:

python main.py

Обычно в консоли выводится:
- первая строка: имя выходного файла + режимы запуска
- далее: прогресс по организациям (если включён enrich)
- итог: saved: <file> rows=<count>

---

## Формат выходного файла

На каждый запуск создаётся один файл:
- out_YYYY-MM-DD_HH-MM-SS.xlsx

Внутри:

1) Лист «Организации»
- ID
- Название
- Адрес
- Индекс
- Долгота / Широта
- Сайт
- Телефон 1..3
- Email 1..3
- Режим работы
- Рейтинг
- Количество отзывов
- Категория 1..3
- Особенности
- uri
- Факс 1..3
- Категории (прочие)
- raw_json (служебная трассировка и диагностика)

2) Лист «Запрос»
- request_time
- режимы запуска
- параметры обработки
- статистика enrich
- предупреждения/ошибки (если были)

---

## Структура проекта

Рекомендуемая структура модульной версии:

.
├─ main.py
├─ settings.py
├─ utils.py
├─ offline_html.py
├─ web_enrich.py
├─ chrome_pool.py
├─ excel_writer.py
├─ requirements.txt
├─ README.md
├─ html
│  └─ .gitkeep
├─ results
│  └─ .gitkeep
└─ debug_extra (опционально, обычно в .gitignore)

---

## Частые проблемы

### 1) 0 организаций в результате
Причины:
- OFFLINE HTML не содержит организаций (не тот файл).
- Выдача не пролистана — в сохранённой странице мало элементов.

Решение:
- пересохранить страницу после полной прокрутки бокового списка;
- проверить OFFLINE_HTML_INPUT.

### 2) В Excel пустые сайт и телефоны
Причины:
- OFFLINE_ENRICH_MODE = NONE
- страница контактов дорисовывается и “быстрый режим” не успевает
- блок контактов отсутствует/скрыт

Решение:
- включить OFFLINE_ENRICH_MODE = WEB
- увеличить SELENIUM_WAIT_CONTACTS_SEC
- проверить, что oid открывается и страница реально содержит контакты

### 3) Ошибки Selenium
Причины:
- неверный путь CHROME_EXE
- конфликт профиля Chrome
- ограничения системы/антивирус/политики

Решение:
- проверьте CHROME_EXE
- используйте отдельный профиль (CHROME_PROFILE_DIR)
- запустите один тестовый oid и посмотрите страницу вручную

### 4) 429 Too Many Requests / временные блокировки
Решение:
- увеличить SLEEP_SEC
- уменьшить WEB_MAX_ITEMS
- запускать реже, не параллелить

---

## .gitignore

Рекомендуемый вариант:

.venv/
pycache/
*.pyc
.idea/

ChromeProfile9222/
debug_extra/

html/*.html
!html/.gitkeep

results/*
!results/.gitkeep

out_*.xlsx
.env

---

## Лицензия и ответственность

Репозиторий:
https://github.com/sadovnikovv/ParserYandexMap.git

Если в проекте присутствует файл LICENSE, использование кода должно соответствовать условиям указанной лицензии.

Юридический отказ от ответственности:

Код предоставляется исключительно в ознакомительных и образовательных целях и предоставляется “как есть”, без каких-либо гарантий.
Автор и/или участники проекта не несут ответственности за любые последствия использования кода, включая прямые и косвенные убытки, блокировки, потерю данных, претензии третьих лиц, а также любое нарушение прав, условий сервисов или требований законодательства.

Пользователь несёт полную и исключительную ответственность за:
- законность сценария использования;
- соблюдение условий сервисов и ограничений доступа;
- соблюдение лицензий сторонних библиотек и контента;
- корректную обработку и хранение данных (включая персональные, если применимо);
- последствия своих действий, включая претензии третьих лиц и юридические риски.

Если вы не согласны с указанными условиями, не используйте данный код.