<!-- =========================================================
     YMaps Excel Export — README
     ========================================================= -->

<div align="center">

# YMaps Excel Export

**Профессиональная выгрузка организаций из Яндекс.Карт (Geosearch API / Places API) в Excel (.xlsx)**

</div>

---

<div align="center">

## Оглавление

</div>

- [1. О проекте](#1-о-проекте)
- [2. Официальная документация Яндекса](#2-официальная-документация-яндекса)
- [3. Архитектура и поток данных](#3-архитектура-и-поток-данных)
- [4. API: endpoint и режимы запросов](#4-api-endpoint-и-режимы-запросов)
- [5. API: параметры запроса (подробно)](#5-api-параметры-запроса-подробно)
- [6. API: формат ответа (что парсится)](#6-api-формат-ответа-что-парсится)
- [7. Настройки программы (main.py)](#7-настройки-программы-mainpy)
- [8. Как запустить](#8-как-запустить)
- [9. Выходной Excel (структура)](#9-выходной-excel-структура)
- [10. Debug/диагностика](#10-debugдиагностика)
- [11. Ограничения и важные замечания](#11-ограничения-и-важные-замечания)

---

<div align="center">

## 1. О проекте

</div>

Проект выполняет поиск организаций в заданной географической области через **API Поиска по организациям** и сохраняет результат в Excel: один запуск — один `.xlsx` файл, внутри лист «Организации» и лист «Запрос».   
Цель — получить удобную табличную выгрузку (контакты, адрес, рубрики, режим работы) и сохранить `raw_json`, чтобы не терять исходные данные. 

---

<div align="center">

## 2. Официальная документация Яндекса

</div>

- Формат запроса (список параметров, endpoint, примеры): https://yandex.ru/dev/geosearch/doc/ru/request   
- Формат ответа (структура GeoJSON, `features`, `properties`, `CompanyMetaData`, `uri`): https://yandex.ru/dev/geosearch/doc/ru/response   

Принципиально важно опираться именно на официально описанные поля ответа и параметры запроса: они считаются поддерживаемыми интерфейсом API. 

---

<div align="center">

## 3. Архитектура и поток данных

</div>

1) Скрипт формирует область поиска (в проекте используется `bbox`) и выполняет основной запрос поиска организаций.   
2) Из ответа берутся `features[]`, далее извлекаются ключевые данные из `properties.CompanyMetaData` и сопутствующих секций (контакты, рубрики, часы работы, особенности).   
3) Опционально выполняется повторный запрос по `uri` (официальный параметр запроса) для уточнения карточки.   
4) Опционально (или как fallback) извлекаются рейтинг и число отзывов из web‑карточки организации, если в API ответе эти поля отсутствуют/не приходят. 

---

<div align="center">

## 4. API: endpoint и режимы запросов

</div>

В проекте используется endpoint API Поиска по организациям: `https://search-maps.yandex.ru/v1/`.   

Сценарии запросов:
- **Режим поиска**: запрос с `text` + гео-ограничением (`bbox` или альтернативные гео-параметры) → список организаций в `features`.   
- **Режим запроса по объекту**: запрос с `uri` (вместо `text`) → данные по конкретному объекту.   

---

<div align="center">

## 5. API: параметры запроса (подробно)

</div>

Ниже описаны параметры API, которые используются в программе, а также наиболее типовые параметры API из документации (чтобы можно было уверенно расширять/модифицировать поведение).   
Для **полного и актуального** перечня параметров, их типов и ограничений всегда сверяйтесь с официальной страницей «Формат запроса». 

### 5.1 Обязательные/базовые

- `apikey` — ключ доступа к API (обязательный).   
  Использование в проекте: берётся из `.env` переменной `YM_API_KEY`.

- `lang` — язык ответа (например `ru_RU`).   
  Использование в проекте: константа `LANG`.

- `type` — тип результата/объектов поиска (в проекте используется `biz`, т.е. организации).   
  Использование в проекте: фиксировано `type="biz"`.

### 5.2 Параметры режима поиска (когда ищем список)

- `text` — поисковая строка.   
  Использование в проекте: константа `TEXT`.

- Гео-ограничение (в проекте выбран `bbox`):
  - `bbox` — прямоугольная область поиска в виде `lon1,lat1~lon2,lat2`.   
    Использование в проекте: вычисляется из `CENTER_LON/CENTER_LAT/DIAMETER_KM`.
  - `rspn` — режим интерпретации гео-ограничения (в проекте используется `rspn=1`, чтобы ограничивать поисковую выдачу областью).   

> Примечание: API поддерживает несколько способов задать область поиска; проект стандартизирует это через `bbox`, так проще контролировать геометрию области. 

### 5.3 Пагинация/лимиты

- `results` — размер страницы выдачи (обычно до 50).   
  Использование в проекте: `RESULTS_PER_PAGE` (рекомендуется 50 для эффективности).

- `skip` — смещение (пагинация), обычно ограничено сверху (например до 1000).   
  Использование в проекте: цикл `skip=0..MAX_SKIP` шагом `RESULTS_PER_PAGE`.

### 5.4 Параметры режима по объекту

- `uri` — идентификатор объекта, который приходит в ответе поиска в `properties.uri`.   
  Использование в проекте: при включённом `ENABLE_URI_REQUERY` выполняется повторный запрос по `uri`, чтобы попытаться получить более полную карточку в рамках официального API. 

### 5.5 Практические замечания по параметрам

- Если запрос отправлен без `text` и без `uri`, API вернёт ошибку (по смыслу: “должен быть text или uri”).   
- Даже при `uri`‑requery состав полей в `CompanyMetaData` может быть таким же, как в выдаче, и не обязан включать “все поля, которые видны на сайте”.   

---

<div align="center">

## 6. API: формат ответа (что парсится)

</div>

Ответ API представляет собой GeoJSON‑структуру с массивом `features`, где каждый элемент содержит `geometry` и `properties`, включая `CompanyMetaData` для организаций.   

В проекте извлекаются (если присутствуют):
- `properties.CompanyMetaData.id`, `name`, `address`, `Address.formatted`, `Address.postal_code`, `url`.   
- `properties.CompanyMetaData.Phones` (телефоны, email, fax — приводятся в колонки “Телефон 1..3”, “Email 1..3”, “Факс 1..3”).   
- `properties.CompanyMetaData.Categories` (рубрики → “Категория 1..3” + “Категории (прочие)”).   
- `properties.CompanyMetaData.Hours` (режим работы → в одну строку).   
- `properties.CompanyMetaData.Features` (особенности → в одну строку).   
- `properties.uri` (служебное поле для `uri`‑requery).   
- `geometry.coordinates` (долгота/широта).   

---

<div align="center">

## 7. Настройки программы (main.py)

</div>

Все настройки делятся на 4 группы: “поиск”, “география”, “вывод”, “обогащение/диагностика”. 

### 7.1 Поиск
- `TEXT` — запрос.   
- `LANG` — язык ответа.   

### 7.2 География
- `CENTER_LON`, `CENTER_LAT` — центр.  
- `DIAMETER_KM` — диаметр области (км).  
На их основе рассчитывается `bbox` для API запроса.   

### 7.3 Пагинация и нагрузка
- `RESULTS_PER_PAGE` → `results`.   
- `MAX_SKIP` → предел `skip`.   
- `SLEEP_SEC` — пауза между запросами (снижает шанс 429).   

### 7.4 Вывод
- `OUT_DIR` — каталог сохранения.  
- `OUT_PREFIX` — префикс имени файла, формат: `out_YYYY-MM-DD_HH-MM-SS.xlsx`.  

### 7.5 Обогащение и диагностические флаги
- `ENABLE_URI_REQUERY` — делает дополнительный официальный запрос по `uri`.   
- `ENABLE_UNOFFICIAL_ENRICH` — включает чтение web‑карточки для рейтинга/отзывов (неофициально).   
- `ENABLE_WEB_FALLBACK_FOR_RATING` — fallback: если API (включая uri‑requery) не дал рейтинг/отзывы, добрать их с web‑карточки.   
- `EXTRA_DEBUG`, `EXTRA_MAX_ITEMS`, `EXTRA_DEBUG_DIR` — управляют логами и ограничивают число объектов, для которых делается enrich/debug (защита от “переспама” и лишней нагрузки).  

---

<div align="center">

## 8. Как запустить

</div>

1) Создайте `.env` и укажите `YM_API_KEY`.   
2) Настройте параметры в шапке `main.py` (TEXT, географию, лимиты).  
3) Запустите:
python main.py

Ожидаемый вывод в консоли:
- строка со сформированным именем файла и параметрами поиска;
- прогресс `skip=...` (если включён вывод по страницам);
- итог `done: rows=...` и `saved`.

---

<div align="center">

## 9. Выходной Excel (структура)

</div>

Файл: `out_YYYY-MM-DD_HH-MM-SS.xlsx`.

Лист **«Организации»**:
- Основные: ID, Название, Адрес, Индекс, Долгота, Широта, Сайт. 
- Контакты: Телефон 1..3, Email 1..3, Факс 1..3. 
- Описание: Режим работы, Категории, Особенности. 
- Репликация/отладка: uri, raw_json. 

Лист **«Запрос»**:
- Время запуска;
- исходные параметры (TEXT, LANG, центр/диаметр);
- рассчитанный bbox;
- лимиты/паузы;
- ошибка, если была.

---

<div align="center">

## 10. Debug/диагностика

</div>

При включённом debug сохраняются файлы в папку `debug_extra`:
- `uri_<id>.json` — полный ответ API на запрос по `uri` (официально).   
- `uri_<id>_matches.json` — диагностический поиск “rating/review” по JSON (помогает доказательно понять, что нужных полей в ответе нет).   
- `web_<oid>_extract.json` — итог извлечения рейтинга/отзывов из HTML карточки (если включены web-режимы).   

---

<div align="center">

## 11. Ограничения и важные замечания

</div>

1) API Поиска возвращает данные в структуре и объёме, описанном в документации; поля, которых нет в документированном ответе, не стоит считать “обязательными”.   
2) Рейтинг/отзывы часто отсутствуют в API ответе даже при `uri`‑requery; это не “поломка”, а различие между API‑данными и тем, что отображается на сайте.   
3) Web‑fallback (HTML‑парсинг) не является официальной частью API и может перестать работать при изменениях на стороне Яндекса.   
4) Для стабильной работы соблюдайте лимиты (`results/skip`) и используйте паузы между запросами.   

---

<div align="center">

### Рекомендуемый .gitignore

</div>

.venv/
__pycache__/
.idea/
*.xlsx
.env
debug_extra/
