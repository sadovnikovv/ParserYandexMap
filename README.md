<!-- Title -->
<h1 align="center">YMaps Excel Export (ParserYandexMap_main)</h1>

<p align="center">
  Выгрузка организаций из Яндекс.Карт в Excel (.xlsx): <b>ONLINE API</b> / OFFLINE HTML + enrich (API requery / WEB) + Selenium fallback (remote-debug Chrome)
</p>

<p align="center">
  <a href="#-возможности">Возможности</a> •
  <a href="#-режимы-работы">Режимы работы</a> •
  <a href="#-требования">Требования</a> •
  <a href="#-установка">Установка</a> •
  <a href="#-настройка">Настройка</a> •
  <a href="#-настройка-selenium">Настройка Selenium</a> •
  <a href="#-запуск">Запуск</a> •
  <a href="#-формат-выходного-файла">Формат выходного файла</a> •
  <a href="#-структура-проекта">Структура проекта</a> •
  <a href="#-частые-проблемы">Частые проблемы</a> •
  <a href="#-gitignore">.gitignore</a> •
  <a href="#-лицензия-и-ответственность">Лицензия и ответственность</a>
</p>

---

────────────────────────────────────────────────────────
НАЗВАНИЕ И КРАТКОЕ ОПИСАНИЕ
────────────────────────────────────────────────────────

YMaps Excel Export (ParserYandexMap_main)

Выгрузка организаций из Яндекс.Карт в Excel (.xlsx) с двумя режимами работы:
- ONLINEAPI — поиск через Yandex Search Maps API в заданной области (bbox).
- OFFLINEHTML — парсинг заранее сохранённых HTML-страниц выдачи Яндекс.Карт.

Дополнительно:
- Enrich-дозаполнение данных по организациям (API requery и/или Web-карточка).
- Selenium-fallback через Chrome с remote debugging, когда данные подгружаются JavaScript.
- Автоматическое сохранение параметров запуска и результатов в Excel.

---

## ✨ Возможности

────────────────────────────────────────────────────────
2. НАЗНАЧЕНИЕ И ВОЗМОЖНОСТИ
────────────────────────────────────────────────────────

2.1. Основные задачи
- Сбор списка организаций из Яндекс.Карт по заданному поисковому запросу и региону.
- Экспорт результатов в Excel-файл с удобной структурой колонок.
- Логирование параметров выполнения (режимы, настройки, статистика, ошибки) в отдельном листе Excel.

2.2. Источники данных
- ONLINEAPI: официальный Yandex Search Maps API (тип biz, bbox по центру и диаметру).
- OFFLINEHTML: сохранённые HTML-страницы выдачи (боковой список организаций).

2.3. Дозаполнение (enrich)
- NONE — без дозаполнения.
- API — uri-requery к API по uri организации, дозаполнение только пустых полей.
- WEB — разбор web-карточки организации (requests + BeautifulSoup + Selenium-fallback).
- APIWEB — комбинация: сначала API, затем WEB (для оставшихся пустых полей).

2.4. Выходной формат
- На каждый запуск создаётся один файл Excel.
- Лист «Организации» — табличные данные (название, адрес, контакты, категории и т.д.).
- Лист «Запрос» — параметры запуска (режимы, bbox, лимиты), статистика и сообщения об ошибках/предупреждениях.

---

## 🧩 Режимы работы

────────────────────────────────────────────────────────
3. РЕЖИМЫ РАБОТЫ
────────────────────────────────────────────────────────

Режимы задаются через переменную `MODE` (из `.env`) и читаются через `Settings.from_env()`.

3.1. MODE=ONLINEAPI
- Поиск организаций через API по тексту `TEXT` в прямоугольнике `bbox`,
  рассчитанном из `CENTER_LON/CENTER_LAT/DIAMETER_KM`.

3.2. MODE=OFFLINEHTML
- Парсинг сохранённого HTML (файл или папка с *.html).
- Далее (опционально) применяется enrich-дозаполнение по `OFFLINE_ENRICH_MODE`.

---

## ✅ Требования

────────────────────────────────────────────────────────
4. СИСТЕМНЫЕ ТРЕБОВАНИЯ И ЗАВИСИМОСТИ
────────────────────────────────────────────────────────

4.1. Окружение
- Python: 3.10+ (рекомендуется).
- ОС: Windows 10/11; возможен запуск на Linux/macOS при корректной настройке окружения.
- Браузер: Google Chrome (для Selenium-fallback).

4.2. Основные зависимости (requirements.txt)
- requests
- beautifulsoup4
- openpyxl
- selenium
- python-dotenv

4.3. Dev-зависимости (requirements-dev.txt)
- pytest
- requests-mock

---

## 🛠️ Установка

────────────────────────────────────────────────────────
5. УСТАНОВКА ПРОЕКТА
────────────────────────────────────────────────────────

5.1. Клонирование репозитория
```bash
git clone https://github.com/sadovnikovv/ParserYandexMap.git
cd ParserYandexMap
```

5.2. Виртуальное окружение (рекомендуется)

Windows (cmd):

text
python -m venv .venv
.venv\Scripts\activate
Windows (PowerShell):

powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
Linux/macOS:

bash
python3 -m venv .venv
source .venv/bin/activate
5.3. Установка зависимостей

bash
pip install -r requirements.txt
Для тестов:

bash
pip install -r requirements-dev.txt
⚙️ Настройка
────────────────────────────────────────────────────────
6. НАСТРОЙКА ПРОЕКТА (.ENV И SETTINGS)
────────────────────────────────────────────────────────

Вся конфигурация собрана в dataclass Settings (config.py).
Settings.from_env() загружает .env из корня проекта и формирует экземпляр Settings с учётом значений окружения и дефолтов.

6.1. Где хранится .env

.env должен лежать в корне проекта (на уровень выше пакета, где находится config.py).

В .env задаются режимы, входные пути, ключ API, лимиты, настройки Selenium.

6.2. Важный нюанс с ключом API

В актуальном коде ожидается переменная YMAPIKEY (слитно), а не YM_API_KEY.

Если у вас есть старый .env.example — переименуйте переменную.

6.3. Быстрые примеры .env

OFFLINEHTML + WEB enrich:

text
MODE=OFFLINEHTML
OFFLINE_HTML_INPUT=./html
OFFLINE_ENRICH_MODE=WEB

OUT_DIR=./results
OUT_PREFIX=out

WEB_MAX_ITEMS=200
SLEEP_SEC=0.25
ONLINEAPI:

text
MODE=ONLINEAPI
YMAPIKEY=PUT_YOUR_KEY_HERE

TEXT=Металлообработка
LANG=ru_RU

CENTER_LON=37.6173
CENTER_LAT=55.7558
DIAMETER_KM=40

RESULTS_PER_PAGE=50
MAX_SKIP=1000
STRICT_BBOX=1

SLEEP_SEC=0.25
OUT_DIR=./results
OUT_PREFIX=out
6.4. Справочник параметров (кратко)

Режим:

MODE: ONLINEAPI | OFFLINEHTML

OFFLINE_HTML_INPUT: путь к папке *.html или к одному HTML-файлу

OFFLINE_ENRICH_MODE: NONE | API | WEB | APIWEB

ONLINEAPI:

YMAPIKEY: ключ Yandex Search Maps API

TEXT: текстовый запрос

LANG: ru_RU (и др.)

CENTER_LON / CENTER_LAT: центр области

DIAMETER_KM: диаметр области (км)

RESULTS_PER_PAGE: размер страницы

MAX_SKIP: ограничение пагинации

STRICT_BBOX: 1/0 (rspn=1)

Паузы:

SLEEP_SEC: задержка между запросами/итерациями

WEB enrich:

WEB_FORCE_OVERWRITE: перезаписывать или только заполнять пустые

WEB_MAX_ITEMS: лимит на количество организаций

WEB_TIMEOUT_SEC: таймаут запросов

Selenium:

CHROME_EXE

DEBUG_HOST / DEBUG_PORT

CHROME_PROFILE_DIR

CHROME_START_TIMEOUT_SEC

SELENIUM_HEADLESS

SELENIUM_PAGE_WAIT_SEC

SELENIUM_WAIT_CONTACTS_SEC

CLOSE_EXISTING_DEBUG_CHROME

🌐 ONLINEAPI (Yandex API)
────────────────────────────────────────────────────────
7. РЕЖИМ ONLINEAPI (ЯНДЕКС API)
────────────────────────────────────────────────────────

7.1. Назначение

Выполнить поиск организаций через Yandex Search Maps API по TEXT в bbox,
рассчитанном из CENTER_LON/CENTER_LAT/DIAMETER_KM.

Собрать найденные features с пагинацией (RESULTS_PER_PAGE и MAX_SKIP).

Преобразовать каждый feature в строку Company для Excel.

7.2. Как работает поиск (в общих чертах)

bbox рассчитывается функцией bbox_from_center_diameter_km().

поиск выполняется через search_bbox(), postранично по skip.

при временных ошибках/лимитах применяются ретраи (429/5xx).

в случае ошибки Excel создаётся с пустым списком и описанием ошибки в листе «Запрос».

7.3. Практические рекомендации

При 429 увеличивайте SLEEP_SEC, уменьшайте интенсивность и объём (RESULTS_PER_PAGE/MAX_SKIP).

Для тестов уменьшайте DIAMETER_KM и MAX_SKIP.

📄 OFFLINEHTML
────────────────────────────────────────────────────────
8. РЕЖИМ OFFLINEHTML
────────────────────────────────────────────────────────

8.1. Как подготовить HTML правильно
OFFLINEHTML парсит только то, что реально сохранено в HTML.
Если боковой список не пролистать до конца — в HTML не будет всех организаций.

Рекомендуемый порядок:

Открыть выдачу Яндекс.Карт.

Пролистать боковой список до конца (пока элементы перестанут догружаться).

Сохранить страницу в HTML.

Положить файлы в папку ./html (или указать конкретный файл в OFFLINE_HTML_INPUT).

8.2. Что парсится

Боковой список: элементы вида [data-object="search-list-item"][data-id].

Извлекаются: oid (ID), название, адрес, категория, рейтинг/отзывы (если есть),
координаты/uri (если доступны).

🧪 Enrich (API / WEB / APIWEB)
────────────────────────────────────────────────────────
9. ENRICH-ДОЗАПОЛНЕНИЕ
────────────────────────────────────────────────────────

9.1. NONE

OFFLINE_ENRICH_MODE=NONE

Никаких дополнительных запросов: в Excel только то, что было в HTML.

9.2. API (uri-requery)

OFFLINE_ENRICH_MODE=API

Требуется YMAPIKEY.

Для каждой компании с uri выполняется requery, дозаполняются только пустые поля.

9.3. WEB (requests + bs4 + Selenium fallback)

OFFLINE_ENRICH_MODE=WEB

Открывается web-карточка организации:

пытаемся извлечь телефоны/сайт/email/рейтинг/отзывы,

если контент дорисовывается JS — используем Selenium.

WEB_FORCE_OVERWRITE управляет перезаписью/дозаполнением.

9.4. APIWEB

OFFLINE_ENRICH_MODE=APIWEB

Сначала API, затем WEB.

🧠 Настройка Selenium
────────────────────────────────────────────────────────
10. НАСТРОЙКА SELENIUM
────────────────────────────────────────────────────────

10.1. Зачем он нужен
Selenium используется как fallback, когда:

данные догружаются JavaScript;

requests/bs4 не видит контакты/сайт;

появляется challenge/captcha.

10.2. Принцип работы (remote debugging)

Запускается Chrome с remote debugging (или используется уже запущенный).

Selenium подключается к этому Chrome через debuggerAddress.

Скрипт ждёт появления контактов и читает page_source.

10.3. Пример настроек (.env)

text
CHROME_EXE=C:\Program Files\Google\Chrome\Application\chrome.exe
DEBUG_HOST=127.0.0.1
DEBUG_PORT=9222
CHROME_PROFILE_DIR=./ChromeProfile9222

SELENIUM_HEADLESS=0
SELENIUM_PAGE_WAIT_SEC=1.0
SELENIUM_WAIT_CONTACTS_SEC=12
CHROME_START_TIMEOUT_SEC=15
CLOSE_EXISTING_DEBUG_CHROME=0
10.4. Если появилась проверка (captcha/challenge)

Посмотрите на окно Chrome.

Решите проверку вручную.

Вернитесь в консоль и нажмите Enter (скрипт продолжит выполнение).

▶️ Запуск
────────────────────────────────────────────────────────
11. ЗАПУСК
────────────────────────────────────────────────────────

Из корня проекта:

bash
python -m ymaps_excel_export.cli
Если имя пакета другое — используйте:

bash
python -m <PACKAGE_NAME>.cli
Обычно в консоли выводится:

прогресс (если VERBOSE=1),

итог: saved: <file> rows=<count>.

📊 Формат выходного файла
────────────────────────────────────────────────────────
12. ФОРМАТ ВЫХОДНОГО ФАЙЛА
────────────────────────────────────────────────────────

12.1. Имя файла

OUT_PREFIX_YYYY-MM-DD_HH-MM-SS.xlsx в папке OUT_DIR.

12.2. Лист «Организации»
Примерный набор колонок:

ID, Название, Адрес, Индекс, Долгота, Широта, Сайт

Телефон 1..3

Email 1..3

Режим работы

Рейтинг, Количество отзывов

Категория 1..3

Особенности

uri

Факс 1..3

Категории (прочие)

raw_json

12.3. Лист «Запрос»

request_time

режимы запуска и параметры

bbox (для ONLINEAPI)

статистика enrich

предупреждения/ошибки

saved / rows

🗂️ Структура проекта
────────────────────────────────────────────────────────
13. СТРУКТУРА ПРОЕКТА
────────────────────────────────────────────────────────

Рекомендуемая структура модульной версии:

text
.
├─ ymaps_excel_export/
│  ├─ __init__.py
│  ├─ cli.py
│  ├─ config.py
│  ├─ pipeline.py
│  ├─ models.py
│  ├─ utils.py
│  ├─ yandex_api.py
│  ├─ offline_html.py
│  ├─ web_enrich.py
│  ├─ selenium_pool.py
│  └─ excel_writer.py
├─ requirements.txt
├─ requirements-dev.txt
├─ .env                # не коммитить
├─ html/
│  └─ *.html
└─ results/
   └─ out_*.xlsx
🧨 Частые проблемы
────────────────────────────────────────────────────────
14. ЧАСТЫЕ ОШИБКИ И ИХ ИСПРАВЛЕНИЕ
────────────────────────────────────────────────────────

14.1) 0 организаций (OFFLINEHTML)
Причины:

файл не тот / нет бокового списка;

выдача не пролистана — в сохранённом HTML мало элементов.

Решение:

пересохранить страницу после полной прокрутки бокового списка;

проверить OFFLINE_HTML_INPUT.

14.2) Пустые сайт/телефоны
Причины:

OFFLINE_ENRICH_MODE=NONE;

контент дорисовывается JS;

контакты отсутствуют на карточке.

Решение:

включить OFFLINE_ENRICH_MODE=WEB или APIWEB;

увеличить SELENIUM_WAIT_CONTACTS_SEC;

проверить карточку вручную.

14.3) Ошибки Selenium
Причины:

неверный CHROME_EXE;

порт DEBUG_PORT занят;

профиль конфликтует/заблокирован политиками.

Решение:

исправить CHROME_EXE;

сменить DEBUG_PORT;

использовать отдельный CHROME_PROFILE_DIR.

14.4) 429 Too Many Requests
Решение:

увеличить SLEEP_SEC;

уменьшить WEB_MAX_ITEMS;

запускать реже, не параллелить.

📄 .gitignore
────────────────────────────────────────────────────────
15. .GITIGNORE
────────────────────────────────────────────────────────

Рекомендуемый вариант:

text
.venv/
__pycache__/
*.pyc
.idea/

ChromeProfile9222/
debug_extra/

html/*.html
!html/.gitkeep

results/*
!results/.gitkeep

out_*.xlsx
.env
⚖️ Лицензия и ответственность
────────────────────────────────────────────────────────
16. ЛИЦЕНЗИЯ И ОТВЕТСТВЕННОСТЬ
────────────────────────────────────────────────────────

Если в проекте присутствует файл LICENSE, использование кода должно соответствовать условиям указанной лицензии.

Юридический отказ от ответственности:
Код предоставляется исключительно в ознакомительных и образовательных целях и предоставляется “как есть”, без каких-либо гарантий.
Автор и/или участники проекта не несут ответственности за любые последствия использования кода, включая прямые и косвенные убытки, блокировки, потерю данных, претензии третьих лиц, а также любое нарушение прав, условий сервисов или требований законодательства.

Пользователь несёт полную и исключительную ответственность за:

законность сценария использования;

соблюдение условий сервисов и ограничений доступа;

соблюдение лицензий сторонних библиотек и контента;

корректную обработку и хранение данных (включая персональные, если применимо);

последствия своих действий, включая претензии третьих лиц и юридические риски.

Если вы не согласны с указанными условиями, не используйте данный код.