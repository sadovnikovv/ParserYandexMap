<!-- Title -->
<h1 align="center">YMaps Excel Export (ParserYandexMap_main)</h1>

<p align="center">
  Выгрузка организаций из Яндекс.Карт в Excel (.xlsx): <b>ONLINE API</b> / OFFLINE HTML + enrich (API requery / WEB) + Selenium fallback (remote‑debug Chrome) + <b>SELENIUM live</b> (ручной выбор области/фильтров)
</p>

<p align="center">
  <a href="#название-и-краткое-описание">Описание</a> •
  <a href="#назначение-и-возможности">Назначение</a> •
  <a href="#режимы-работы">Режимы</a> •
  <a href="#системные-требования-и-зависимости">Требования</a> •
  <a href="#настройка-проекта-env-и-settings">Настройка</a> •
  <a href="#onlineapi-яндекс-search-maps-api">ONLINEAPI</a> •
  <a href="#offlinehtml-парсинг-сохранённых-страниц">OFFLINEHTML</a> •
  <a href="#enrich-api--web--apiweb">Enrich</a> •
  <a href="#selenium-fallback-remote-debugging">Selenium</a> •
  <a href="#формат-выходного-excel-файла">Excel</a> •
  <a href="#логи-и-диагностика">Логи</a> •
  <a href="#тесты">Тесты</a> •
  <a href="#структура-проекта-рекомендуемая">Структура</a> •
  <a href="#частые-проблемы">Проблемы</a> •
  <a href="#план-развития-browser-режим">План</a> •
  <a href="#лицензия-и-отказ-от-ответственности">Лицензия</a>
</p>

---

## НАЗВАНИЕ И КРАТКОЕ ОПИСАНИЕ

YMaps Excel Export (ParserYandexMap_main)

Проект собирает организации из Яндекс.Карт и сохраняет результат в Excel (.xlsx).
Поддерживаются источники:
- ONLINEAPI — поиск через Yandex Search Maps API в заданной области (bbox).
- OFFLINEHTML — парсинг заранее сохранённых HTML‑страниц выдачи Яндекс.Карт.
- SELENIUM — “живой” режим: открывается Яндекс.Карта в Chrome, пользователь выбирает область/фильтры/сортировку, затем экспортируется список из боковой панели.

Дополнительно:
- Enrich‑дозаполнение: API requery (по uri) и/или разбор WEB‑карточки.
- Selenium‑fallback: подключение к Chrome через remote debugging для страниц, где контент дорисовывается JavaScript.
- Ведение метаданных запуска (параметры, статистика, ошибки) в отдельном листе Excel.

---

## НАЗНАЧЕНИЕ И ВОЗМОЖНОСТИ

Основные задачи:
- Быстро получить таблицу организаций (название, адрес, контакты, категории, рейтинг и т.д.) в Excel.
- Разделить “получение списка” и “дозаполнение карточек” (чтобы не гонять лишние запросы).
- Сохранить диагностику выполнения внутри Excel (лист “Запрос”) и сырой трассинг данных в raw_json.

Дополнительный сценарий (для подбора места “вручную”):
- Можно открыть Яндекс.Карты в <b>SELENIUM live</b>, выбрать нужный район (зум/перемещение), применить фильтры (например “Рейтинг”) и/или отсортировать список.
- После этого программа выгрузит именно тот список, который вы видите в боковой панели — удобно выбрать кафе “самое популярное по отзывам”, “самое крутое по рейтингу” и т.д.

---

## РЕЖИМЫ РАБОТЫ

MODE:
- ONLINEAPI — поиск через API по параметрам TEXT + bbox.
- OFFLINEHTML — разбор сохранённого HTML (локальная выдача), затем (опционально) enrich.
- SELENIUM — живой режим: пользователь открывает Я.Карты в Chrome, настраивает зону/фильтры/сортировку и подтверждает экспорт.

OFFLINE_ENRICH_MODE:
- NONE — без дозаполнения.
- API — дозаполнение через uri‑requery к API (нужен ключ).
- WEB — дозаполнение через web‑карточку (requests + BeautifulSoup, при необходимости Selenium).
- APIWEB — сначала API, потом WEB (для оставшихся пустых полей).

<b>Важно про “Режим работы” в SELENIUM live</b>:
- Пока в live‑режиме в колонку “Режим работы” чаще записывается только статус (например “Открыто до 22:00” / “Закрыто до …”), а не полноценный недельный график.
- Это осознанное ограничение: сейчас нет времени заниматься отловом редких случаев, где расписание парсится нестабильно.
- Если нужен максимально точный график — используйте платный <b>ONLINEAPI</b> / enrich‑цепочку с API (OFFLINE_ENRICH_MODE=API или APIWEB).

---

## СИСТЕМНЫЕ ТРЕБОВАНИЯ И ЗАВИСИМОСТИ

Окружение:
- Python 3.10+ рекомендуется.
- ОС: Windows 10/11 (возможен запуск на Linux/macOS при корректной настройке окружения).
- Google Chrome (нужен для Selenium‑fallback и SELENIUM‑режима).

Python‑зависимости:
- requests
- beautifulsoup4
- openpyxl
- selenium
- python-dotenv

Dev‑зависимости:
- pytest
- requests-mock

---

## НАСТРОЙКА ПРОЕКТА (.ENV И SETTINGS)

Вся конфигурация хранится в Settings (config.py) и читается из окружения через Settings.from_env().

ВАЖНО про .env:
- В <b>.env</b> допускается хранить только ключ API (YM_API_KEY или YMAPIKEY для совместимости).
- Остальные параметры (MODE, таймауты, лимиты и т.п.) меняются либо в config.py (дефолты), либо через переменные окружения (но не через .env).

.env и .env.example должны лежать в корне проекта (на уровень выше пакета).

---

## СПРАВОЧНИК ПАРАМЕТРОВ (.ENV)

Режим:
- MODE: ONLINEAPI | OFFLINEHTML | SELENIUM
- OFFLINE_HTML_INPUT: путь к HTML‑файлу или папке с HTML (для OFFLINEHTML)
- OFFLINE_ENRICH_MODE: NONE | API | WEB | APIWEB

Ключ и ONLINEAPI:
- YM_API_KEY: ключ Yandex Search Maps API
- YMAPIKEY: запасное имя ключа (совместимость)
- TEXT: поисковый запрос
- LANG: локаль ответа API (по умолчанию ru_RU)
- CENTER_LON, CENTER_LAT: центр области поиска
- DIAMETER_KM: диаметр области поиска (км)
- RESULTS_PER_PAGE: размер страницы API
- MAX_SKIP: максимальный skip (ограничение пагинации)
- STRICT_BBOX: 1/0 (если 1, используется rspn=1 для строгого ограничения областью)

Паузы и стабильность:
- SLEEP_SEC: задержка между запросами (при 429 рекомендуется увеличить)

Флаги enrich:
- ENABLE_URI_REQUERY: включение uri‑requery по API
- ENABLE_WEB_FALLBACK_FOR_RATING: разрешить WEB/Selenium‑fallback для рейтинга

Ограничители колонок:
- MAX_PHONES: максимум телефонов (по умолчанию 3)
- MAX_EMAILS: максимум email (по умолчанию 3)
- MAX_FAXES: максимум факсов (по умолчанию 3, но сейчас в Excel используется только “Факс 1”)
- MAX_CATEGORIES_MAIN: максимум основных категорий (по умолчанию 3)

Выход:
- OUT_DIR: папка для результатов (по умолчанию ./results)
- OUT_PREFIX: префикс имени файла (по умолчанию out)

WEB‑enrich:
- WEB_FORCE_OVERWRITE: перезаписывать ли уже заполненные поля при WEB‑enrich
- WEB_MAX_ITEMS: лимит организаций на enrich (0 = без лимита)
- WEB_TIMEOUT_SEC: таймаут сетевых операций (сек)

Selenium / Chrome (remote debugging):
- CHROME_EXE: путь к chrome.exe
- DEBUG_HOST, DEBUG_PORT: host/port remote debugging (по умолчанию 127.0.0.1:9222)
- CHROME_PROFILE_DIR: отдельный профиль Chrome для работы парсера
- CHROME_START_TIMEOUT_SEC: ожидание запуска debug‑Chrome
- SELENIUM_HEADLESS: 1/0 (headless или с окном)
- SELENIUM_PAGE_WAIT_SEC: задержка после открытия страницы
- SELENIUM_WAIT_CONTACTS_SEC: ожидание появления контактов/сайта в DOM
- CLOSE_EXISTING_DEBUG_CHROME: закрывать ли уже запущенный debug‑Chrome

SELENIUM live mode:
- SELENIUM_START_URL: стартовый URL (по умолчанию https://yandex.ru/maps/)
- SELENIUM_WAIT_FOR_ENTER: ожидать Enter перед сбором списка
- SELENIUM_SCROLL_TO_END: автоматически пролистывать боковую панель до конца
- SELENIUM_SCROLL_MAX_SEC: максимальное время автопрокрутки
- SELENIUM_SCROLL_STEP_SEC: пауза между “шагами” прокрутки
- SELENIUM_SCROLL_STABLE_ROUNDS: сколько раз подряд должен “не меняться список”, чтобы считать что дошли до конца
- SELENIUM_OPEN_URL_IN_NEW_TAB: открывать карточки в новой вкладке (удобнее для живой карты)
- SELENIUM_RETURN_TO_ORIGINAL_TAB: возвращаться на вкладку с выдачей после сбора
- SELENIUM_KEEP_CHROME_OPEN: не закрывать Chrome после завершения (удобно для серии прогонов)

Логи:
- VERBOSE: подробный вывод в консоль

---

## ONLINEAPI (ЯНДЕКС SEARCH MAPS API)

Назначение:
- Выполнить поиск организаций по TEXT в bbox‑области.
- Собрать результаты с пагинацией (skip/results) до MAX_SKIP.
- Дедуплицировать по ID и сформировать строки для Excel.

Технические особенности:
- Используется endpoint Search Maps API: https://search-maps.yandex.ru/v1
- В запросе используется type=biz, bbox, lang, apikey, text, results, skip.
- При STRICT_BBOX=1 добавляется rspn=1.

Обработка ошибок и ретраи:
- Для статусов 429/5xx используется повтор с backoff (увеличение задержки).
- При 403 обычно причина — неверный ключ (YM_API_KEY).

---

## OFFLINEHTML: ПАРСИНГ СОХРАНЁННЫХ СТРАНИЦ

Назначение:
- Взять сохранённые HTML‑страницы выдачи Яндекс.Карт и извлечь список организаций (боковая панель выдачи).

Критично важный момент:
- В HTML должно быть реально загружено “всё”, иначе список будет неполным.
- Перед сохранением HTML рекомендуется прокрутить боковую панель до конца, чтобы элементы догрузились.

---

## ENRICH (API / WEB / APIWEB)

Идея:
- OFFLINEHTML обычно даёт “скелет” списка.
- Enrich добирает контакты/сайт/рейтинг/категории и другие поля из API и/или web‑карточки.

API enrich (uri‑requery):
- Работает по uri организации.
- Заполняет поля, которых не хватило после OFFLINEHTML (как правило — контакты и уточнения).

WEB enrich:
- Загружает web‑карточку организации.
- Если контент дорисован JavaScript — подключает Selenium и берёт итоговый HTML (page_source).

APIWEB:
- Сначала API (быстро и стабильнее).
- Потом WEB (дотягивает то, чего нет в API или не пришло).

---

## SELENIUM FALLBACK (REMOTE DEBUGGING)

Когда нужен:
- Контакты/сайт/часть карточки недоступны “статическим” requests+bs4.
- Данные появляются только после выполнения JavaScript.
- Требуется ручное прохождение challenge/captcha (если появится).

Как устроено:
- Используется Chrome с remote debugging на DEBUG_PORT.
- Selenium подключается к уже запущенному Chrome и получает HTML после ожиданий.

<b>SELENIUM live</b> (ручной подбор “лучшего кафе”):
- Откройте Яндекс.Карты, введите запрос (например “Кафе” / “Где поесть”).
- Выберите область поиска (приближение/перемещение карты) — по сути вы сами задаёте “зону обработки”.
- Примените фильтры (например “Рейтинг”) и/или отсортируйте боковой список: можно выбрать “самое популярное по отзывам” или “самое крутое по рейтингу”.
- Пролистайте боковую панель до конца (или включите авто‑прокрутку), затем нажмите Enter — программа соберёт ровно то, что отображается в списке.

Ограничение (временно):
- В live‑режиме “Режим работы” может сохраняться как “время до закрытия” (статус), а не полный недельный график.
- Если нужен точный график — предпочтительнее использовать платный ONLINEAPI и enrich через API.

---

## ФОРМАТ ВЫХОДНОГО EXCEL‑ФАЙЛА

На каждый запуск создаётся один Excel‑файл в OUT_DIR (имя начинается с OUT_PREFIX).

Лист “Организации” (заголовки):
- ID
- Название
- Адрес
- Индекс
- Долгота
- Широта
- Сайт
- Телефон 1
- Телефон 2
- Телефон 3
- Email 1
- Email 2
- Email 3
- Режим работы
- Рейтинг
- Количество отзывов
- Категория 1
- Категория 2
- Категория 3
- Особенности
- uri
- Факс 1
- Категории (прочие)
- raw_json

Лист “Запрос”:
- Параметры запуска (MODE/ENRICH/координаты/лимиты и т.д.)
- Статистика (сколько найдено/дедуп/сохранено)
- Предупреждения и ошибки (если были)

---

## ЛОГИ И ДИАГНОСТИКА

Где смотреть:
- Консоль: прогресс, warnings, сообщения про fallback, итог сохранения.
- Excel: лист “Запрос” — полная диагностика запуска.
- raw_json: сырые данные и трассинг источника (полезно для отладки и проверки качества).

---

## ТЕСТЫ

В проекте предусмотрены автотесты на pytest:
- тесты CLI
- тесты утилит
- тесты пайплайна
- тесты работы с Excel writer
- тесты yandex_api
- тесты web_enrich

---

## СТРУКТУРА ПРОЕКТА (РЕКОМЕНДУЕМАЯ)

Ключевые файлы и модули:
- config.py — Settings и чтение окружения / .env (ключ API)
- cli.py / main.py — точка входа консольного режима
- pipeline.py — основной сценарий выполнения
- yandex_api.py — ONLINEAPI и uri‑requery
- offline_html.py — OFFLINEHTML парсер
- web_enrich.py — WEB‑enrich (requests/bs4 + fallback)
- selenium_pool.py — управление Chrome remote debugging и Selenium
- selenium_manual_maps.py — SELENIUM live режим (сбор из живой выдачи)
- excel_writer.py — формирование Excel (листы “Организации” / “Запрос”)
- models.py — модели данных (Company и др.)
- utils.py — утилиты (env_*, bbox, логирование, форматирование)

Служебные каталоги:
- html/ — входные HTML (OFFLINEHTML)
- results/ — выходные Excel
- ChromeProfile9222/ — профиль Chrome для remote debugging

---

## ЧАСТЫЕ ПРОБЛЕМЫ

1) Ключ не подхватился
- Проверьте, что задан YM_API_KEY (или YMAPIKEY для совместимости).
- Проверьте, что .env лежит в корне проекта.

2) OFFLINEHTML дал неполный список
- Скорее всего HTML сохранён без полной прогрузки боковой панели.
- Пересохраните HTML после полной прокрутки списка до конца.

3) Пустые контакты/сайт после OFFLINEHTML
- Это нормально без enrich.
- Включите OFFLINE_ENRICH_MODE=API / WEB / APIWEB.

4) 429 Too Many Requests
- Увеличьте SLEEP_SEC.
- Для WEB‑enrich можно ограничить WEB_MAX_ITEMS (если нужно).

5) В SELENIUM live “Режим работы” только “Открыто до …”
- На текущий момент это ожидаемое поведение.
- Если критичен полный график — используйте ONLINEAPI и enrich через API (платный метод).

---

## ЛИЦЕНЗИЯ И ОТКАЗ ОТ ОТВЕТСТВЕННОСТИ

Лицензия:
- Если в проекте присутствует файл LICENSE, использование кода должно соответствовать условиям указанной лицензии.

Юридический отказ от ответственности: Код предоставляется исключительно в ознакомительных и образовательных целях и предоставляется “как есть”, без каких-либо гарантий. Автор и/или участники проекта не несут ответственности за любые последствия использования кода, включая прямые и косвенные убытки, блокировки, потерю данных, претензии третьих лиц, а также любое нарушение прав, условий сервисов или требований законодательства.
Пользователь несёт полную и исключительную ответственность за:
законность сценария использования;
соблюдение условий сервисов и ограничений доступа;
соблюдение лицензий сторонних библиотек и контента;
корректную обработку и хранение данных (включая персональные, если применимо);
последствия своих действий, включая претензии третьих лиц и юридические риски.
Если вы не согласны с указанными условиями, не используйте данный код.